{% load custom_project_tags %}

{% if request.user.is_authenticated %}
    <div class="auto-margin" style="max-width: 1271px;">
        <a class="pointer underline-hover margin-top-2 margin-left-8" onClick="window.history.back();return false;">
            <i class="fa fa-arrow-left darkteal-text margin-right-8"></i> Go back
        </a>
    </div>
{% endif %}

<div class="flex-this auto-margin" style="max-width: 1271px;">

    <!-- PROJECT -->
    <div class="project-card content-card-space">
        <h1>{{ project.title }}</h1>
        <div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Date created</p></div>
                <div><p>{{ project.date_added|date:'d M Y' }}</p></div>
            </div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Project type</p></div>
                <div><p>{{ project.project_type }}</p></div>
            </div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Project Visibility</p></div>
                <div><p>{{ project.project_privacy }}</p></div>
            </div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Creator</p></div>
                <div>
                    <p>
                        {% firstof creator.community creator.institution creator.researcher %}
                    </p>
                </div>
            </div>
            <div class="flex-this">
                <div class="project-left-sidebar"><p class="bold">Status</p></div>
                <div><p>Active</p></div>
            </div>
        </div>

        <div>
            <div class="border-top-solid-teal border-bottom-solid-teal">
                <h2>Project details</h2>
            </div>
            <div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Description</p></div>
                    <div><p>{{ project.description|linebreaks }}</p></div>
                </div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Contact</p></div>
                    <div><p>{{ project.project_contact }}<br>{{ project.project_contact_email }}</p></div>
                </div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Links</p></div>
                    <div> 
                        {% if project.urls %}
                            <ul>
                                {% for url in project.urls %}
                                    <li>
                                        <a href="{{ url }}" class="darkteal-text underline-hover word-break" target="_blank" rel="noopener">{{ url }} <i class="fa fa-external-link" aria-hidden="true"></i></a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No links added</p>
                        {% endif %}
                    </div>
                </div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Contributors</p></div>
                    <div>                    
                        <ul>
                            {% if project.project_contributors.communities %}
                                {% for community in project.project_contributors.communities.all %}
                                    <li>{{ community.community_name }} | Community</li>
                                {% endfor %}
                            {% endif %}

                            {% if project.project_contributors.institutions %}
                                {% for institution in project.project_contributors.institutions.all %}
                                    <li>{{ institution.institution_name }} | Institution <br></li>
                                {% endfor %}
                            {% endif %}

                            {% if project.project_contributors.researchers %}
                                {% for researcher in project.project_contributors.researchers.all %}
                                    <li>
                                        <div class="researcher-hover">
                                            {% if researcher.orcid %}
                                                <a class="darkteal-text" itemprop="sameAs" content="{{ researcher.orcid }}" href="{{ researcher.orcid }}" target="orcid.widget" rel="me noopener noreferrer" style="vertical-align:top;">
                                                    <img loading="lazy" src="https://orcid.org/sites/default/files/images/orcid_16x16.png" style="margin-top:2.5px;" alt="ORCID iD icon">
                                                </a>
                                            {% endif %}

                                            {% firstof researcher.user.get_full_name researcher.user.username %} | Researcher
                                            <div class="researcher-hover-info">
                                                <p>
                                                    <strong>Primary Institution Affiliation:</strong> {% if researcher.primary_institution %}{{ researcher.primary_institution }}{% else %} None specified {% endif %}<br>
                                                    <strong>About:</strong> {% if researcher.description %} {{ researcher.description }} {% else %} No description available{% endif %}
                                                </p>
                                                
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            {% endif %}
                            {% if project.additional_contributors %}
                                {% for contributor in project.additional_contributors.all %}
                                    <li>{{ contributor.name }} | Contributor </li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="flex-this">
                    <div class="project-left-sidebar"><p class="bold">Identifiers</p></div>
                    <div>
                        <p>
                            <span class="bold">Local Contexts Project ID</span><br>
                            {{ project.unique_id }}<br><br>

                            <span class="bold">Providers ID</span><br>
                            {{ project.providers_id }}<br><br>

                            <span class="bold">Publication DOI</span><br>
                            {{ project.publication_doi }}<br><br>

                            <span class="bold">Project Data GUID</span><br>
                            {{ project.project_data_guid }}<br><br>
                        </p>
                    </div>
                </div>
            </div>

            {% if notices %}
                <div class="border-top-solid-teal border-bottom-solid-teal">
                    <h2>Project Notices</h2>
                </div>
                <div>
                    {% for notice in notices %}
                        <div class="flex-this">
                            <div class="project-left-sidebar">
                                <p class="bold">
                                    {% if notice.notice_type == 'biocultural' %}
                                        Biocultural
                                    {% endif %}
                                    {% if notice.notice_type == 'traditional_knowledge' %}
                                        Traditional Knowledge
                                    {% endif %}
                                    {% if notice.notice_type == 'attribution_incomplete' %}
                                        Attribution Incomplete
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                <div class="margin-top-16">
                                    <img loading="lazy" src="{{ notice.img_url }}" width="78" height="78" alt="black square with white letters TK in the middle">
                                </div>
                                <p>
                                    {{ notice.default_text }} <br>
                                </p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if project.has_bclabels or project.has_tklabels %}
                <div class="border-top-solid-teal border-bottom-solid-teal">
                    <h2>Project Labels</h2>
                </div>
                <div>
                    {% for tklabel in project.tk_labels.all %}
                        <div class="flex-this">
                            <div class="project-left-sidebar"><p class="bold">{{ tklabel.name }}</p></div>
                            <div>
                                <div class="flex-this margin-top-16">
                                    <div>
                                        {% include 'tklabels/which-label.html' %} 
                                    </div>
                                    <div class="margin-left-16">
                                        <p class="no-top-margin bold">Label applied by {{ tklabel.community.community_name }}</p><br>
                                    </div>
                                </div>

                                <h3>{{ tklabel.language }}</h3>
                                <p>
                                    {{ tklabel.label_text }} <br>
                                </p>
                                {% for translation in tklabel.tklabel_translation.all %}
                                    <h3>{{ translation.language }}</h3>
                                    <p>
                                        {{ translation.translated_text }}
                                    </p>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if request.user.is_authenticated %}
                <div class="border-top-solid-teal border-bottom-solid-teal">
                    <h2>Project messages</h2>
                </div>
                <div>
                    {% include 'projects/project-comment.html'%}
                </div>
            {% endif %}

        </div>
    </div>

    <!-- ACTIONS  -->
    <div class="margin-left-16">
        <div class="actions-card content-card-space flex-this column">
            <h3 class="no-top-margin">Actions</h3>

            {% if request.user.is_authenticated %}
                {% if community %}
                    {% if member_role == 'admin' or member_role == 'editor' %}
                        <a class="block" href="{% url 'apply-labels' community.id project.unique_id %}"> <i class="fa-solid fa-tag"></i> Apply Labels</a>
                    {% endif %}
                {% endif %}

                {% if request.user == project.project_creator %}
                    <a 
                        class="block" 
                        {% if community %}
                            href="{% url 'edit-project' community.id project.unique_id %}"
                        {% endif %}
                        {% if institution %}
                            href="{% url 'inst-edit-project' institution.id project.unique_id %}"
                        {% endif %}
                        {% if researcher %}
                            href="{% url 'researcher-edit-project' researcher.id project.unique_id %}"
                        {% endif %}
                    ><i class="fa-solid fa-pen-to-square"></i> Edit Project</a>
                {% endif %}

                {% if institution %}
                    {% if institution.is_approved %}
                        {% if member_role == 'admin' or member_role == 'editor' %}
                            <a 
                                class="block" 
                                href="{% url 'institution-notify-others' institution.id project.unique_id %}"
                            ><i class="fa-solid fa-user-group"></i> Notify Communities</a>
                        {% endif %}
                    {% endif %}
                {% endif %}

                {% if researcher %}
                    <a 
                        class="block" 
                        {% if researcher %}
                            href="{% url 'researcher-notify-others' researcher.id project.unique_id %}"
                        {% endif %}
                    ><i class="fa-solid fa-user-group"></i> Notify Communities</a>
                {% endif %}

                <!-- TODO: implement this -->
                <!-- <a class="block" href="#"><i class="fa-solid fa-box-archive"></i> Archive</a> -->
                <div class="border-bottom-grey margin-top-8 margin-bottom-8"></div>
            {% endif %}
            {% if project.project_privacy == 'Public' %}
                <a id="shareBtn" class="block pointer" onclick="copyProjectUrl('projectPageUrl', 'shareBtn')"><i class="fa-solid fa-share-nodes"></i> Share</a>
                <input type="text" value="{{ project.project_page}}" id="projectPageUrl" class="hide">

                <a class="block" href="{% url 'download-project-zip' project.unique_id %}"><i class="fa-solid fa-download"></i> Download</a>
            {% endif %}
        </div>  

        <!-- Community: set project status -->
        {% if community %}
            {% if not project_creator.community %}
                {% include 'projects/project-status.html' %}
            {% endif %}
        {% endif %}


        <!-- List of communities notified -->
        {% project_status project as statuses %}
        {% if statuses %}
            <div class="actions-card content-card-space flex-this column">
                <div class="flex-this">
                    <h3 class="no-top-margin no-bottom-margin">Communities Notified</h3>
                    <div class="tooltip" style="margin-top: 6px; margin-left: 5px;"><strong>i</strong>
                        <span class="tooltiptext">
                            Listed below are the communities that have been notified about this Project. After the name of the notified community is the status of their decision about the Project.<br><br>
                            <i class="bold">Seen</i><br> The community has acknowledged the Project but has not made a decision about applying Labels.<br>
                            <i class="bold">No Labels Pending</i><br> The community will not apply Labels to the Project.<br>
                            <i class="bold">Labels Pending</i><br> The community is deciding which Label(s) to apply to the Project.<br>
                            <i class="bold">Labels Applied</i><br> The community has applied Labels to the Project.
                        </span>
                    </div>                     
                </div>

                <div class="border-bottom-grey">
                    <p>
                        Listed below are the communities that have been notified about this Project 
                        including the status of their decision about the Project.
                    </p>
                </div>

                {% for status in statuses %}
                    <div class="border-bottom-grey">
                        <div><p><span class="bold">{{ status.community }}</span></p></div>
                        <div>
                            <p><em> Project status: </em>
                                {% if status.seen and status.status == None %} Seen
                                {% elif status.seen and status.status == 'pending' %} Labels Pending
                                {% elif status.seen and status.status == 'not_pending' %} No Labels Pending
                                {% elif status.seen and status.status == 'labels_applied' %} Labels Applied
                                {% else %} Sent {% endif %}
                            </p>
                        </div>    
                    </div>
                {% endfor %}
            </div>
        {% endif %}

    </div>

</div>

<script>
    function copyProjectUrl(projectPageUrl, elemID) {
        let target = document.getElementById(projectPageUrl)
        let copyBtn = document.getElementById(elemID)
        let initialHTML = copyBtn.innerHTML
        
        if (target.value) {
            target.select()
            target.setSelectionRange(0, 99999)
            navigator.clipboard.writeText(target.value)
            copyBtn.innerHTML = 'Project link copied!'
            setTimeout(() => {
                copyBtn.innerHTML = initialHTML
            }, 1500)
        }
    }
</script>