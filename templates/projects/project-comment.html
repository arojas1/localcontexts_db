{% load static %} {% load custom_project_tags %}
<div class="border-top-solid-teal">

    <!-- RESEARCHER AND INSTITUTION -->
    {% if researcher or institution %}
        {% project_status project as statuses %}

        {% if statuses %}
            <h3 class="no-bottom-margin">Project Comments</h3>
            {% for status in statuses %}
                <div class="flex-this space-between w-100 margin-top-16">
                    <div><p><span class="bold">{{ status.community }}</span></p></div>
                    <div>
                        <p class="grey-text"><em>Status: 
                            {% if status.seen and status.status == None %} Seen
                            {% elif status.seen and status.status == 'pending' %} Labels Pending
                            {% elif status.seen and status.status == 'not_pending' %} No Labels Pending
                            {% else %} Sent
                            {% endif %}</em>
                        </p>
                    </div>    
                </div>

                {% if institution %}
                    {% project_comments project status.community as comments %}
                    {% if comments %}
                        {% for comment in comments %}
                            {% if comment.community.community_name in status.community.community_name %}
                                <div class="flex-this w-80 project-comment">
                                    <div class="project-comment-teal"></div>
                                    <div class="project-comment-text">
                                        <span class="bold">
                                            {% if  comment.sender.get_full_name %}
                                                {{  comment.sender.get_full_name }}
                                            {% else %}
                                                {{  comment.sender.username }}
                                            {% endif %}
                                        </span>
                                        <span class="grey-text">{{ comment.created|date:'m/d/Y' }}</span><br>
                                        <p>{{ comment.message }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% if member_role == 'admin' or member_role == 'editor' %}
                            <div class="margin-top-16">
                                <form method="POST" action="">
                                    {% csrf_token %}
                                    <input type="hidden" value="{{ project.unique_id }}" name="project-uuid">
                                    <input type="hidden" value="{{ status.community.id }}" name="community-id">
                                    <div class="flex-this row">
                                        <div class="w-50">{{ form.message }}</div>
                                        <div class="margin-left-1"><button class="primary-btn action-btn" name="add-comment-btn">Send</button></div>
                                    </div>
                                    {% if form.errors %}
                                        <div class="msg-red w-50"><small>{{ form.errors.as_text }}</small></div> 
                                    {% endif %}
                                </form>        
                            </div>
                        {% endif %} 
                    {% endif %}
                {% endif %}

                {% if researcher %}
                    {% project_comments project status.community as comments %}
                    {% if comments %}
                        {% for comment in comments %}
                            {% if comment.community.community_name in status.community.community_name %}
                                <div class="flex-this w-80 project-comment">
                                    <div class="project-comment-teal"></div>
                                    <div class="project-comment-text">
                                        <span class="bold">
                                            {% if  comment.sender.get_full_name %}
                                                {{  comment.sender.get_full_name }}
                                            {% else %}
                                                {{  comment.sender.username }}
                                            {% endif %}
                                        </span>
                                        <span class="grey-text">{{ comment.created|date:'m/d/Y' }}</span><br>
                                        <p>{{ comment.message }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% if member_role == 'admin' or member_role == 'editor' %}
                            <div class="margin-top-16">
                                <form method="POST" action="">
                                    {% csrf_token %}
                                    <input type="hidden" value="{{ project.unique_id }}" name="project-uuid">
                                    <input type="hidden" value="{{ status.community.id }}" name="community-id">
                                    <div class="flex-this row">
                                        <div class="w-50">{{ form.message }}</div>
                                        <div class="margin-left-1"><button class="primary-btn action-btn" name="add-comment-btn">Send</button></div>
                                    </div>
                                    {% if form.errors %}
                                        <div class="msg-red w-50"><small>{{ form.errors.as_text }}</small></div> 
                                    {% endif %}
                                </form>        
                            </div>
                        {% endif %} 
                    {% endif %}
                {% endif %}
            {% endfor %}

        {% endif %}
    {% endif %}

    <!-- COMMUNITY  -->
    {% if community %}
        {% project_comments project community as comments %}
        <h3 class="no-bottom-margin">Project Comments</h3>

        {% if comments %}

            <div>
                <p><span class="bold">
                    {% if project.project_notice.researcher %} 
                        {% if project.project_notice.researcher.user.get_full_name %}
                            {{ project.project_notice.researcher.user.get_full_name }}
                        {% else %}
                            {{ project.project_notice.researcher.user.username }}
                        {% endif %}
                    {% endif %}
                    {% if project.project_notice.institution %} {{ project.project_notice.institution.institution_name }} {% endif %}
                </span></p>
            </div>

            {% for comment in comments %}
                <div class="flex-this w-80 project-comment">
                    <div class="project-comment-teal"></div>
                    <div class="project-comment-text">
                        <span class="bold">
                            {% if comment.sender.get_full_name %}
                                {{ comment.sender.get_full_name }}
                            {% else %}
                                {{ comment.sender.username }}
                            {% endif %}
                        </span>
                        <span class="grey-text">{{ comment.created|date:'m/d/Y' }}</span><br>
                        <p>{{ comment.message }}</p>
                    </div>
                </div>
            {% endfor %}
            {% if member_role == 'admin' or member_role == 'editor' %}
                <div class="margin-top-16">
                    <form method="POST" action="">
                        {% csrf_token %}
                        <input type="hidden" value="{{ project.unique_id }}" name="project-uuid">
                        <input type="hidden" value="{{ status.community.id }}" name="community-id">
                        <div class="flex-this row">
                            <div class="w-50">{{ form.message }}</div>
                            <div class="margin-left-1"><button class="primary-btn action-btn" name="add-comment-btn">Send</button></div>
                        </div>
                        {% if form.errors %}
                            <div class="msg-red w-50"><small>{{ form.errors.as_text }}</small></div> 
                        {% endif %}
                    </form>        
                </div>
            {% endif %} 
        {% endif %}
    {% endif %}

</div>
